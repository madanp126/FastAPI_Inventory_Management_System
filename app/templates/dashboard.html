{% extends "base.html" %}

{% block content %}

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

    <a
      href="javascript:void(0);"
      onclick="document.getElementById('addProductModal').classList.remove('hidden')"
      class="bg-white border border-blue-200 hover:shadow-md rounded-lg p-6 block hover:scale-105 transition"
    >
        <div class="flex items-center justify-between">
            <div>
                <h4 class="text-lg font-semibold text-blue-600">Add Product</h4>
                <p class="text-sm text-gray-600">Add new electronic gadget to inventory</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i data-lucide="plus" class="h-6 w-6 text-blue-600"></i>
            </div>
        </div>
    </a>

<!--    <a href="{{ products_url | default('/product_info/sales_T') }}" class="bg-white border border-purple-200 hover:shadow-md rounded-lg p-6 block hover:scale-105 transition">-->
<!--        <div class="flex items-center justify-between">-->
<!--            <div>-->
<!--                <h4 class="text-lg font-semibold text-purple-600">Sales & Transactions</h4>-->
<!--                <p class="text-sm text-gray-600">Browse and manage stock inventory</p>-->
<!--            </div>-->
<!--            <div class="bg-purple-100 p-3 rounded-full">-->
<!--                <i data-lucide="list" class="h-6 w-6 text-purple-600"></i>-->
<!--            </div>-->
<!--        </div>-->
<!--    </a>-->

    <a href="javascript:void(0);" onclick="showSalesTransactions()"
   class="bg-white border border-purple-200 hover:shadow-md rounded-lg p-6 block hover:scale-105 transition">
   <div class="flex items-center justify-between">
     <div>
       <h4 class="text-lg font-semibold text-purple-600">Sales & Transactions</h4>
       <p class="text-sm text-gray-600">Browse and manage stock inventory</p>
     </div>
     <div class="bg-purple-100 p-3 rounded-full">
       <i data-lucide="list" class="h-6 w-6 text-purple-600"></i>
     </div>
   </div>
</a>



</div>

<!-- Recent Products -->
<div id="recentProductSection" class="bg-white rounded-lg shadow-sm p-6 fade-in">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Products</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-700">
            <thead class="text-xs uppercase bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="py-3 px-4">Sr.No.</th>
                    <th class="py-3 px-4">Product</th>
                    <th class="py-3 px-4">Category</th>
                    <th class="py-3 px-4">Stock</th>
                    <th class="py-3 px-4">Price</th>
                    <th class="py-3 px-4">Status</th>
                    <th class="py-3 px-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in recent_products %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">{{ loop.index }}</td>
                    <td class="py-3 px-4">{{ product.product_name }}</td>
                    <td class="py-3 px-4">{{ product.category }}</td>
                    <td class="py-3 px-4">{{ product.quantity }}</td>
                    <td class="py-3 px-4">₹{{ product.price }}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs {% if product.status == 'In Stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                            {{ product.status }}
                        </span>
                    </td>
                    <td class="py-3 px-4 space-x-2">
                    <!-- Restock Button -->
                    <button
                        onclick="openRestockModal('{{ product.product_id }}', '{{ product.product_name }}', '{{ product.category }}', {{ product.quantity }}, {{ product.price }})"
                        class="bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-500 text-xs">
                        Restock
                    </button>


                    <!-- Delete Button -->
                    <form method="POST" action="/product_info/sell" class="inline">
                        <input type="hidden" name="product_id" value="{{ product.product_id }}">
                        <button type="submit"
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-xs"
                            onclick="return confirm('Are you sure you want to Sell this product?');">
                            Sell
                        </button>
                    </form>
                </td>

                </tr>
                {% else %}
                <tr><td colspan="5" class="py-4 text-center text-gray-400">No products added yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!--sold products-->
<div id="salesTransactionSection" class="bg-white rounded-lg shadow-sm p-6 fade-in hidden">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Sold Products</h3>
    <button onclick="showRecentProducts()" class="mb-4 bg-gray-100 hover:bg-gray-200 text-sm px-3 py-1 rounded">
      ← Back to Recent Products
    </button>
    <div class="overflow-x-auto">

        <table class="w-full text-sm text-left text-gray-700">
            <thead class="text-xs uppercase bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="py-3 px-4">Sr.No.</th>
                    <th class="py-3 px-4">Product</th>
                    <th class="py-3 px-4">Category</th>
                    <th class="py-3 px-4">Stock</th>
                    <th class="py-3 px-4">Price</th>
                    <th class="py-3 px-4">Status</th>
                    <th class="py-3 px-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in sold_products %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">{{ loop.index }}</td>
                    <td class="py-3 px-4">{{ product.product_name }}</td>
                    <td class="py-3 px-4">{{ product.category }}</td>
                    <td class="py-3 px-4">{{ product.quantity }}</td>
                    <td class="py-3 px-4">₹{{ product.price }}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs {% if product.status == 'In Stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                            {{ product.status }}
                        </span>
                    </td>
                    <td class="py-3 px-4 space-x-2">
                    <!-- Restock Button -->
                    <button
                        onclick="openRestockModal('{{ product.product_id }}', '{{ product.product_name }}', '{{ product.category }}', {{ product.quantity }}, {{ product.price }})"
                        class="bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-500 text-xs">
                        Restock
                    </button>

                </td>

                </tr>
                {% else %}
                <tr><td colspan="5" class="py-4 text-center text-gray-400">No products sold yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Add Product Modal -->
<div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="document.getElementById('addProductModal').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-red-500">
      ✕
    </button>
    <h3 class="text-xl font-bold mb-4 text-blue-700">Add New Product</h3>
    <form method="POST" action="/product_info/add" enctype="multipart/form-data">
      <div class="mb-4">
        <label class="block mb-1 font-medium">Product Name</label>
        <input name="product_name" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Category</label>
        <input name="category" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Quantity</label>
        <input name="quantity" required type="number" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Price (₹)</label>
        <input name="price" required type="number" step="0.01" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="text-right">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Add Product
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Restock Product Modal -->
<div id="restockModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="document.getElementById('restockModal').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-red-500">✕</button>
    <h3 class="text-xl font-bold mb-4 text-yellow-700">Restock Product</h3>
    <form method="POST" action="/product_info/restock">
        <input type="hidden" name="product_id" id="restock_product_id">
      <div class="mb-4">
        <label class="block mb-1 font-medium">Product Name</label>
        <input name="product_name" id="restock_name" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Category</label>
        <input name="category" id="restock_category" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Quantity</label>
        <input name="quantity" id="restock_quantity" required type="number" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Price (₹)</label>
        <input name="price" id="restock_price" required type="number" step="0.01" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="text-right">
        <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Update</button>
      </div>
    </form>
  </div>
</div>

<script>
function showSalesTransactions() {
  document.getElementById("recentProductSection").classList.add("hidden");
  document.getElementById("salesTransactionSection").classList.remove("hidden");
}

function showRecentProducts() {
  document.getElementById("salesTransactionSection").classList.add("hidden");
  document.getElementById("recentProductSection").classList.remove("hidden");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const updated = urlParams.get("updated");
    const sold = urlParams.get("sold");

    if (updated === "1") {
        Swal.fire({
            title: 'Updated Successfully!',
            text: 'The product has been restocked.',
            icon: 'success',
            confirmButtonText: 'OK'
        }).then(() => {
            // Clean the URL after showing alert
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        });
    }
    if (sold=="1"){
        Swal.fire({
            title: 'Sold Successfully!',
            text: 'The product has been sold.',
            icon: 'success',
            confirmButtonText: 'OK'
        }).then(() => {
            // Clean the URL after showing alert
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        });
    }
</script>


<script>
// Enhanced form submission

function openRestockModal(productId,name, category, quantity, price) {
    document.getElementById('restockModal').classList.remove('hidden');
    document.getElementById('restock_product_id').value= productId;
    document.getElementById('restock_name').value = name;
    document.getElementById('restock_category').value = category;
    document.getElementById('restock_quantity').value = quantity;
    document.getElementById('restock_price').value = price;
}


document.querySelector('#addProductModal form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Adding...';

    try {
        const response = await fetch(e.target.action, {
            method: 'POST',
            body: new FormData(e.target)
        });

        if (response.redirected) {
            window.location.href = response.url;
        } else if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add product');
        }
    } catch (error) {
        alert(error.message);
        console.error('Error:', error);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Add Product';
    }
});
</script>

<script>
    lucide.createIcons();
</script>

{% endblock %}
