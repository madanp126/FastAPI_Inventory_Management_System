{% extends "base.html" %}

{% block content %}

<div class="flex">
<!-- Sidebar Navigation -->
<aside class="w-full md:w-64 bg-white shadow-md h-full md:min-h-screen p-4">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Admin Panel</h2>

  <nav class="space-y-4 text-sm font-medium text-gray-700">

    <!-- Products Dropdown -->
    <div x-data="{ open: false }" class="space-y-1">
      <button @click="open = !open"
        class="w-full flex items-center justify-between px-4 py-2 rounded-md text-left bg-gray-50 hover:bg-blue-100 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-300">
        <span class="text-blue-700 font-semibold">Manage Products</span>
        <svg xmlns="http://www.w3.org/2000/svg"
          :class="{ 'rotate-180': open }"
          class="h-4 w-4 transition-transform duration-300"
          fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <!-- Animated Dropdown Items -->
      <div x-show="open" x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="opacity-0 translate-y-2"
           x-transition:enter-end="opacity-100 translate-y-0"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-y-0"
           x-transition:leave-end="opacity-0 translate-y-2"
           class="pl-6 space-y-1 mt-1"
           x-cloak>

          <a href="javascript:void(0);"
                   onclick="document.getElementById('addProductModal').classList.remove('hidden')"
           class="block px-2 py-1 rounded hover:bg-blue-50 hover:text-blue-700 transition">
          ‚ûï Add Products
        </a>
        <a href="javascript:void(0);" onclick="showRecentProducts()"
           class="block px-2 py-1 rounded hover:bg-blue-50 hover:text-blue-700 transition">
          üì¶ View Products
        </a>
        <a href="javascript:void(0);" onclick="showSalesTransactions()"
           class="block px-2 py-1 rounded hover:bg-blue-50 hover:text-blue-700 transition">
          üí∞ View Transactions
        </a>
      </div>
    </div>

  </nav>
</aside>

  <!-- Main Content -->
  <main class="flex-1 px-6">

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

    <a
      href="javascript:void(0);"
      onclick="document.getElementById('addProductModal').classList.remove('hidden')"
      class="bg-white border border-blue-200 hover:shadow-md rounded-lg p-6 block hover:scale-105 transition"
    >
        <div class="flex items-center justify-between">
            <div>
                <h4 class="text-lg font-semibold text-blue-600">Add Product</h4>
                <p class="text-sm text-gray-600">Add new electronic gadget to inventory</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i data-lucide="plus" class="h-6 w-6 text-blue-600"></i>
            </div>
        </div>
    </a>

<!--    <a href="{{ products_url | default('/product_info/sales_T') }}" class="bg-white border border-purple-200 hover:shadow-md rounded-lg p-6 block hover:scale-105 transition">-->
<!--        <div class="flex items-center justify-between">-->
<!--            <div>-->
<!--                <h4 class="text-lg font-semibold text-purple-600">Sales & Transactions</h4>-->
<!--                <p class="text-sm text-gray-600">Browse and manage stock inventory</p>-->
<!--            </div>-->
<!--            <div class="bg-purple-100 p-3 rounded-full">-->
<!--                <i data-lucide="list" class="h-6 w-6 text-purple-600"></i>-->
<!--            </div>-->
<!--        </div>-->
<!--    </a>-->

    <a href="javascript:void(0);" onclick="showSalesTransactions()"
   class="bg-white border border-purple-200 hover:shadow-md rounded-lg p-6 block hover:scale-105 transition">
   <div class="flex items-center justify-between">
     <div>
       <h4 class="text-lg font-semibold text-purple-600">Sales & Transactions</h4>
       <p class="text-sm text-gray-600">Browse and manage stock inventory</p>
     </div>
     <div class="bg-purple-100 p-3 rounded-full">
       <i data-lucide="list" class="h-6 w-6 text-purple-600"></i>
     </div>
   </div>
</a>



</div>

<!-- Recent Products -->
<div id="recentProductSection" class="bg-white rounded-lg shadow-sm p-6 fade-in">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Products</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-700">
            <thead class="text-xs uppercase bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="py-3 px-4">Sr.No.</th>
                    <th class="py-3 px-4">Product</th>
                    <th class="py-3 px-4">Category</th>
                    <th class="py-3 px-4">Stock</th>
                    <th class="py-3 px-4">Price</th>
                    <th class="py-3 px-4">Status</th>
                    <th class="py-3 px-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in recent_products %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">{{ loop.index }}</td>
                    <td class="py-3 px-4">{{ product.product_name }}</td>
                    <td class="py-3 px-4">{{ product.category }}</td>
                    <td class="py-3 px-4">{{ product.quantity }}</td>
                    <td class="py-3 px-4">‚Çπ{{ product.price }}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs {% if product.status == 'In Stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                            {{ product.status }}
                        </span>
                    </td>
                    <td class="py-3 px-4 space-x-2">
                    <!-- Restock Button -->
                    <button
                        onclick="openRestockModal('{{ product.product_id }}', '{{ product.product_name }}', '{{ product.category }}', {{ product.quantity }}, {{ product.price }})"
                        class="bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-500 text-xs">
                        Restock
                    </button>


<!--                    &lt;!&ndash; Delete Button &ndash;&gt;-->
<!--                    <form method="POST" action="/product_info/sell" class="inline">-->
<!--                        <input type="hidden" name="product_id" value="{{ product.product_id }}">-->
<!--                        <button type="submit"-->
<!--                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-xs"-->
<!--                            onclick="return confirm('Are you sure you want to Sell this product?');">-->
<!--                            Sell-->
<!--                        </button>-->
<!--                    </form>-->
                        <!-- Sell Button (opens modal) -->
                        <button
                            type="button"
                            onclick="openSellModal('{{ product.product_id }}', '{{ product.product_name }}', {{ product.quantity }})"
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-xs">
                            Sell
                        </button>

                </td>

                </tr>
                {% else %}
                <tr><td colspan="5" class="py-4 text-center text-gray-400">No products added yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!--sold products-->
<div id="salesTransactionSection" class="bg-white rounded-lg shadow-sm p-6 fade-in hidden">
   <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-gray-900">Sold Products</h3>
    <button onclick="showRecentProducts()"
            class="bg-gray-100 hover:bg-gray-200 text-sm px-3 py-1 rounded transition-all duration-200">
      ‚Üê Back to Recent Products
    </button>
  </div>
    <div class="overflow-x-auto">

        <table class="w-full text-sm text-left text-gray-700">
            <thead class="text-xs uppercase bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="py-3 px-4">Sr.No.</th>
                    <th class="py-3 px-4">Product</th>
                    <th class="py-3 px-4">Category</th>
                    <th class="py-3 px-4">Stock</th>
                    <th class="py-3 px-4">Price</th>
                    <th class="py-3 px-4">Status</th>
                    <th class="py-3 px-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in sold_products %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">{{ loop.index }}</td>
                    <td class="py-3 px-4">{{ product.product_name }}</td>
                    <td class="py-3 px-4">{{ product.category }}</td>
                    <td class="py-3 px-4">{{ product.quantity }}</td>
                    <td class="py-3 px-4">‚Çπ{{ product.price }}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs {% if product.status == 'In Stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                            {{ product.status }}
                        </span>
                    </td>

                    <td class="py-3 px-4">
                        <!-- Generate Bill Button -->
                        <button
                          onclick="generateBillImage('{{ product.product_name }}', '{{ product.category }}', {{ product.quantity }}, {{ product.price }})"
                          class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-xs">
                          Generate Bill
                        </button>

                    </td>

                </tr>
                {% else %}
                <tr><td colspan="5" class="py-4 text-center text-gray-400">No products sold yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Bill Preview Modal -->
<div id="billModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-4 w-[90%] max-w-3xl relative">
    <button onclick="closeBillModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-xl font-bold">&times;</button>
    <h3 class="text-lg font-semibold text-center mb-4">Generated Bill</h3>
    <img id="billImagePreview" src="" alt="Bill Preview" class="w-full border rounded" />
  </div>
</div>


<!-- Sell Modal -->
<div id="sellModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg w-80 p-6">
    <h2 class="text-lg font-semibold mb-2">Sell Product: <span id="sellProductName"></span></h2>
    <form method="POST" action="/product_info/sell" onsubmit="return validateSellQuantity();">
      <input type="hidden" name="product_id" id="sellProductId">
      <input type="number" name="sell_quantity" id="sellQuantity" min="1" class="w-full border p-2 rounded mb-3" placeholder="Enter quantity to sell" required>
      <p class="text-sm text-gray-500 mb-2">Available stock: <span id="sellAvailableStock"></span></p>
      <div class="flex justify-end space-x-2">
        <button type="button" onclick="closeSellModal()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Confirm</button>
      </div>
    </form>
  </div>
</div>


<!-- Add Product Modal -->
<div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="document.getElementById('addProductModal').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-red-500">
      ‚úï
    </button>
    <h3 class="text-xl font-bold mb-4 text-blue-700">Add New Product</h3>
    <form method="POST" action="/product_info/add" enctype="multipart/form-data">
      <div class="mb-4">
        <label class="block mb-1 font-medium">Product Name</label>
        <input name="product_name" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Category</label>
        <input name="category" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Quantity</label>
        <input name="quantity" required type="number" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Price (‚Çπ)</label>
        <input name="price" required type="number" step="0.01" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="text-right">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Add Product
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Restock Product Modal -->
<div id="restockModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="document.getElementById('restockModal').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-red-500">‚úï</button>
    <h3 class="text-xl font-bold mb-4 text-yellow-700">Restock Product</h3>
    <form method="POST" action="/product_info/restock">
        <input type="hidden" name="product_id" id="restock_product_id">
      <div class="mb-4">
        <label class="block mb-1 font-medium">Product Name</label>
        <input name="product_name" id="restock_name" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Category</label>
        <input name="category" id="restock_category" required type="text" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Quantity</label>
        <input name="quantity" id="restock_quantity" required type="number" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Price (‚Çπ)</label>
        <input name="price" id="restock_price" required type="number" step="0.01" class="w-full border rounded px-3 py-2" />
      </div>
      <div class="text-right">
        <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Update</button>
      </div>
    </form>
  </div>
</div>

      <script src="//unpkg.com/alpinejs" defer></script>

<script>
  function generateBillImage(productName, category, quantity, price) {
    const formData = new FormData();
    formData.append("product_name", productName);
    formData.append("category", category);
    formData.append("quantity", quantity);
    formData.append("price", price);

    fetch("product_info/generate_bill", {
      method: "POST",
      body: formData
    })
    .then(response => response.blob())
    .then(blob => {
      const imageUrl = URL.createObjectURL(blob);
      document.getElementById("billImagePreview").src = imageUrl;
      document.getElementById("billModal").classList.remove("hidden");
    })
    .catch(err => {
      alert("Error generating bill image");
      console.error(err);
    });
  }

  function closeBillModal() {
    document.getElementById("billModal").classList.add("hidden");
    document.getElementById("billImagePreview").src = "";
  }
</script>


      <script>
  function openSellModal(productId, productName, availableStock) {
    document.getElementById('sellProductId').value = productId;
    document.getElementById('sellProductName').innerText = productName;
    document.getElementById('sellAvailableStock').innerText = availableStock;
    document.getElementById('sellQuantity').max = availableStock;
    document.getElementById('sellQuantity').value = '';  // reset previous value
    document.getElementById('sellModal').classList.remove('hidden');
  }

  function closeSellModal() {
    document.getElementById('sellModal').classList.add('hidden');
  }

  function validateSellQuantity() {
    const qtyInput = document.getElementById('sellQuantity');
    const maxQty = parseInt(qtyInput.max);
    const enteredQty = parseInt(qtyInput.value);

    if (enteredQty > maxQty) {
      alert(`Cannot sell more than ${maxQty} units.`);
      return false;
    }
    return true;
  }
</script>

<script>
function showSalesTransactions() {
  document.getElementById("recentProductSection").classList.add("hidden");
  document.getElementById("salesTransactionSection").classList.remove("hidden");
}

function showRecentProducts() {
  document.getElementById("salesTransactionSection").classList.add("hidden");
  document.getElementById("recentProductSection").classList.remove("hidden");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const updated = urlParams.get("updated");
    const sold = urlParams.get("sold");

    if (updated === "1") {
        Swal.fire({
            title: 'Updated Successfully!',
            text: 'The product has been restocked.',
            icon: 'success',
            confirmButtonText: 'OK'
        }).then(() => {
            // Clean the URL after showing alert
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        });
    }
    if (sold=="1"){
        Swal.fire({
            title: 'Sold Successfully!',
            text: 'The product has been sold.',
            icon: 'success',
            confirmButtonText: 'OK'
        }).then(() => {
            // Clean the URL after showing alert
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        });
    }
</script>


<script>
// Enhanced form submission

function openRestockModal(productId,name, category, quantity, price) {
    document.getElementById('restockModal').classList.remove('hidden');
    document.getElementById('restock_product_id').value= productId;
    document.getElementById('restock_name').value = name;
    document.getElementById('restock_category').value = category;
    document.getElementById('restock_quantity').value = quantity;
    document.getElementById('restock_price').value = price;
}


document.querySelector('#addProductModal form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Adding...';

    try {
        const response = await fetch(e.target.action, {
            method: 'POST',
            body: new FormData(e.target)
        });

        if (response.redirected) {
            window.location.href = response.url;
        } else if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add product');
        }
    } catch (error) {
        alert(error.message);
        console.error('Error:', error);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Add Product';
    }
});
</script>

<script>
    lucide.createIcons();
</script>
  </main>
</div>
{% endblock %}

